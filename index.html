<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domain HMAC Password Generator</title>
<style>
  :root{
    --bg: #0b0f14;
    --card: #111827;
    --muted: #6b7280;
    --text: #e5e7eb;
    --accent: #60a5fa;
    --accent-2: #34d399;
    --danger: #f87171;
    --chip: #0b1220;
    --ring: rgba(96,165,250,.35);
  }
  html,body{height:100%;}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 10% -10%, #1f2937 0%, transparent 60%),
      radial-gradient(900px 500px at 90% 110%, #111827 0%, transparent 60%),
      var(--bg);
    color:var(--text); font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    display:grid; place-items:center; padding:24px;
  }
  .card{
    width:min(720px, 100%);
    background:linear-gradient(180deg, #0e1626 0%, #0b1220 100%);
    border:1px solid rgba(148,163,184,.15);
    box-shadow: 0 20px 50px rgba(0,0,0,.45);
    border-radius:18px; padding:26px;
  }
  .header{
    display:flex; align-items:center; gap:12px; margin-bottom:18px;
  }
  .logo{
    width:38px;height:38px; border-radius:12px;
    display:grid;place-items:center;
    background:linear-gradient(135deg, #60a5fa, #22d3ee);
    box-shadow:0 6px 18px rgba(34,211,238,.35);
  }
  .logo svg{filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
  h1{font-size:1.15rem; margin:0;}
  p.sub{margin:4px 0 0; color:var(--muted); font-size:.94rem}
  .row{display:grid; gap:14px; margin-top:8px;}
  .field{
    display:grid; gap:8px;
  }
  label{
    font-size:.93rem; color:#cbd5e1;
  }
  .input{
    position:relative;
  }
  input[type="text"], input[type="password"]{
    width:100%; background:#0b1220; color:#e5e7eb;
    border:1px solid rgba(148,163,184,.18); border-radius:12px;
    padding:14px 44px 14px 14px; outline:none; transition:.2s;
  }
  input::placeholder{color:#6b7280}
  input:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 6px var(--ring);
  }
  .trailing{
    position:absolute; right:10px; top:50%; transform:translateY(-50%); display:flex; gap:6px;
  }
  .iconbtn{
    border:0; background:transparent; cursor:pointer; padding:6px; border-radius:8px;
    color:#9ca3af;
  }
  .iconbtn:hover{background:#0f172a; color:#e5e7eb}
  .chipwrap{display:flex; align-items:center; gap:10px; margin-top:4px;}
  .chiplabel{color:#9aa3b2; font-size:.9rem;}
  .chip{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    background:linear-gradient(180deg, #111b2b, #0d1524);
    border:1px solid rgba(148,163,184,.22);
    padding:8px 10px; border-radius:999px; font-size:.92rem; letter-spacing:.2px; min-width:8ch;
    display:inline-flex; align-items:center; gap:8px;
  }
  .chip .dot{
    width:8px;height:8px;border-radius:999px;background:var(--accent-2); box-shadow:0 0 0 2px rgba(52,211,153,.2);
  }
  .actions{
    display:flex; gap:10px; align-items:center; margin-top:12px;
  }
  .btn{
    display:inline-flex; align-items:center; gap:10px;
    border:0; cursor:pointer; padding:12px 14px; border-radius:12px; font-weight:600;
    background:linear-gradient(135deg, #2563eb, #06b6d4); color:white;
    box-shadow:0 10px 22px rgba(37,99,235,.35);
    transition:transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:disabled{
    filter:grayscale(.6) brightness(.8); cursor:not-allowed; box-shadow:none;
  }
  .btn:not(:disabled):active{ transform:translateY(1px); box-shadow:0 6px 14px rgba(37,99,235,.35);}
  .hint{color:var(--muted); font-size:.9rem}
  .status{
    min-height:24px; margin-left:4px; font-size:.95rem;
    color:#cbd5e1; display:flex; align-items:center; gap:8px;
  }
  .status.ok{color:#86efac}
  .status.err{color:var(--danger)}
  .divider{height:1px; background:linear-gradient(90deg, transparent, rgba(148,163,184,.2), transparent); margin:18px 0;}
  .footer{
    display:flex; justify-content:space-between; align-items:center; color:#94a3b8; font-size:.85rem;
  }
  .kbd{
    border:1px solid rgba(148,163,184,.35); background:#0b1220; border-bottom-width:2px; padding:.1rem .4rem; border-radius:6px; font-family:ui-monospace, monospace;
  }
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}
  .password-display{
    margin-top:12px; padding:14px; background:#0b1220; border:1px solid rgba(148,163,184,.18); border-radius:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size:1rem; letter-spacing:1px; word-break:break-all; line-height:1.8;
    min-height:48px; display:flex; align-items:center;
  }
  .password-display.hidden{
    color:#6b7280; font-style:italic; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    letter-spacing:normal;
  }
  .password-char-a{color:#60a5fa;}
  .password-char-b{color:#34d399;}
</style>
</head>
<body>
  <main class="card" role="form" aria-labelledby="title">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M12 3l2.5 5 5 .7-3.7 3.6.9 5L12 15l-4.7 2.3.9-5L4.5 8.7l5-.7L12 3z" stroke="white" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>
      </div>
      <div>
        <h1 id="title">Domain HMAC Password Generator</h1>
        <p class="sub">Generate a deterministic password from a domain and your secret. The proof updates as you type the secret.</p>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="domain">Domain</label>
        <div class="input">
          <input id="domain" type="text" inputmode="text" autocomplete="off" spellcheck="false" enterkeyhint="go"
                 placeholder="e.g. github.com/myuser+<year>" />
        </div>
      </div>

      <div class="field">
        <label for="secret">Password (secret)</label>
        <div class="input">
          <input id="secret" type="password" autocomplete="new-password" spellcheck="false" enterkeyhint="go"
                 placeholder="Enter your secret…" />
          <div class="trailing">
            <button class="iconbtn" id="toggle" type="button" aria-label="Show or hide password">
              <svg id="eye" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5C5 5 2 12 2 12s3 7 10 7 10-7 10-7-3-7-10-7Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="chipwrap" aria-live="polite">
          <span class="chiplabel">Proof</span>
          <span class="chip" id="proofChip" title="First 6 bytes of HMAC(secret, '') in Base64">
            <span class="dot" aria-hidden="true"></span><span id="proofText">—</span>
          </span>
        </div>
      </div>

      <div class="actions">
        <button id="copyBtn" class="btn" type="button" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="9" y="9" width="11" height="11" rx="2.2" stroke="white" stroke-width="1.6"/>
            <rect x="4" y="4" width="11" height="11" rx="2.2" stroke="white" stroke-width="1.6" opacity=".9"/>
          </svg>
          Copy Password
        </button>
        <button id="viewPasswordBtn" class="iconbtn" type="button" aria-label="Show or hide computed password" disabled title="Show computed password">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 5C5 5 2 12 2 12s3 7 10 7 10-7 10-7-3-7-10-7Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </button>
        <div id="status" class="status" role="status" aria-live="polite"></div>
      </div>

      <div id="passwordDisplay" class="password-display hidden" role="region" aria-live="polite" aria-label="Computed password">
        <span id="passwordText">Password will appear here when you toggle visibility</span>
      </div>

      <div class="divider"></div>
      <div class="footer">
        <span>Use the <em>view button</em> to display the password or <em>copy</em> to clipboard.</span>
        <span><span class="kbd">Enter</span> to copy</span>
      </div>
    </div>
  </main>

<script>
  // --- Utilities ---
  const enc = new TextEncoder();

  function bytesToBase64(bytes){
    let bin = "";
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }

  async function hmacSHA256(keyBytes, messageBytes){
    const key = await crypto.subtle.importKey(
      "raw", keyBytes, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, messageBytes);
    return new Uint8Array(sig);
  }

  async function computeProof(secret){
    if (!secret) return "";
    const key = enc.encode(secret);
    const msg = new Uint8Array(0); // null domain
    const full = await hmacSHA256(key, msg);
    const first6 = full.slice(0, 6);
    return bytesToBase64(first6);
  }

  async function computePassword(secret, domain){
    if (!secret || !domain) return "";
    const key = enc.encode(secret);
    const msg = enc.encode(domain);
    const full = await hmacSHA256(key, msg);
    const first20 = full.slice(0, 20);
    return bytesToBase64(first20);
  }

  async function copyToClipboard(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
      }else{
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.top = "-1000px";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        document.execCommand("copy");
        ta.remove();
      }
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }

  // --- DOM wiring ---
  const domainEl = document.getElementById("domain");
  const secretEl = document.getElementById("secret");
  const proofTextEl = document.getElementById("proofText");
  const copyBtn = document.getElementById("copyBtn");
  const statusEl = document.getElementById("status");
  const toggleBtn = document.getElementById("toggle");
  const eyeIcon = document.getElementById("eye");
  const viewPasswordBtn = document.getElementById("viewPasswordBtn");
  const passwordDisplay = document.getElementById("passwordDisplay");
  const passwordText = document.getElementById("passwordText");

  // Store pre-computed password in memory
  let cachedPassword = "";
  let isPasswordVisible = false;

  // Set dynamic placeholder with current year
  const y = new Date().getFullYear();
  domainEl.placeholder = `e.g. github.com/myuser+${y}`;

  function setStatus(msg, ok=false, err=false){
    statusEl.className = "status" + (ok ? " ok" : "") + (err ? " err" : "");
    statusEl.innerHTML = msg ? (ok ? successIcon() : (err ? errorIcon() : "")) + msg : "";
  }

  function successIcon(){
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="flex:none"><path d="M20 7L9.5 17.5 4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  }
  function errorIcon(){
    return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="flex:none"><path d="M12 9v4m0 4h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
  }

  function updateButtonState(){
    copyBtn.disabled = !(domainEl.value.trim() && secretEl.value);
    viewPasswordBtn.disabled = !(domainEl.value.trim() && secretEl.value);
  }

  async function updateProof(){
    const proof = await computeProof(secretEl.value);
    proofTextEl.textContent = proof || "—";
  }

  async function updatePassword(){
    const domain = domainEl.value.trim();
    const secret = secretEl.value;
    
    if (domain && secret){
      cachedPassword = await computePassword(secret, domain);
      updatePasswordDisplay();
    } else {
      cachedPassword = "";
      updatePasswordDisplay();
    }
  }

  function updatePasswordDisplay(){
    if (!cachedPassword){
      passwordDisplay.classList.add("hidden");
      passwordText.innerHTML = "Password will appear here when you toggle visibility";
      isPasswordVisible = false;
      return;
    }

    if (isPasswordVisible){
      // Display password with alternating colors every 4 characters
      let html = "";
      for (let i = 0; i < cachedPassword.length; i++){
        const char = cachedPassword[i];
        const groupIndex = Math.floor(i / 4);
        const colorClass = groupIndex % 2 === 0 ? "password-char-a" : "password-char-b";
        html += `<span class="${colorClass}">${char}</span>`;
      }
      passwordDisplay.classList.remove("hidden");
      passwordText.innerHTML = html;
    } else {
      passwordDisplay.classList.add("hidden");
      passwordText.innerHTML = "••••••••••••••••••••••••••••";
    }
  }

  function togglePasswordVisibility(){
    isPasswordVisible = !isPasswordVisible;
    updatePasswordDisplay();
    
    // Update button icon
    const svg = viewPasswordBtn.querySelector("svg");
    if (isPasswordVisible){
      svg.innerHTML = `<path d="M3 3l18 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 5C5 5 2 12 2 12s1.06 2.5 3.25 4.37M21.98 12.12S19 5 12 5c-1.15 0-2.23.16-3.24.45" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 9.5a3 3 0 104.95 3.32" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>`;
      viewPasswordBtn.setAttribute("title", "Hide computed password");
    } else {
      svg.innerHTML = `<path d="M12 5C5 5 2 12 2 12s3 7 10 7 10-7 10-7-3-7-10-7Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>`;
      viewPasswordBtn.setAttribute("title", "Show computed password");
    }
  }

  async function handleCopy(){
    setStatus("");
    const domain = domainEl.value.trim();
    const secret = secretEl.value;

    if (!secret){
      setStatus("Enter your secret to generate the proof.", false, true);
      secretEl.focus();
      return;
    }
    if (!domain){
      setStatus("Enter a domain before copying.", false, true);
      domainEl.focus();
      return;
    }

    try{
      // Use pre-computed password for immediate clipboard access
      // Fallback to computing if not ready (e.g., race condition)
      let password = cachedPassword;
      if (!password){
        password = await computePassword(secret, domain);
      }
      if (!password){
        setStatus("Couldn't compute password.", false, true);
        return;
      }
      const ok = await copyToClipboard(password);
      if (ok){
        setStatus("Password copied to clipboard.", true, false);
      }else{
        setStatus("Copy failed. Your browser may block clipboard access.", false, true);
      }
    }catch(err){
      console.error(err);
      setStatus("An error occurred during generation.", false, true);
    }
  }

  // Event listeners
  secretEl.addEventListener("input", () => { updateProof(); updatePassword(); updateButtonState(); });
  domainEl.addEventListener("input", () => { updatePassword(); updateButtonState(); });

  [domainEl, secretEl].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !copyBtn.disabled){
        e.preventDefault();
        handleCopy();
      }
    });
  });

  copyBtn.addEventListener("click", handleCopy);

  toggleBtn.addEventListener("click", () => {
    const isPwd = secretEl.type === "password";
    secretEl.type = isPwd ? "text" : "password";
    // Toggle icon (eye / eye-off)
    eyeIcon.innerHTML = isPwd
      ? `<path d="M3 3l18 18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M12 5C5 5 2 12 2 12s1.06 2.5 3.25 4.37M21.98 12.12S19 5 12 5c-1.15 0-2.23.16-3.24.45" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.5 9.5a3 3 0 104.95 3.32" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>`
      : `<path d="M12 5C5 5 2 12 2 12s3 7 10 7 10-7 10-7-3-7-10-7Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/>`;
    secretEl.focus();
  });

  viewPasswordBtn.addEventListener("click", togglePasswordVisibility);

  // OFdaYNwtCR31KuK0oIuPGTkLHE8=
  // OFdaYNwtCR31KuK0oIuPGTkLHE8=
  updateProof();
  updateButtonState();
</script>
</body>
</html>
